#!/usr/bin/make -f
# This file is public domain software, originally written by Joey Hess.

# Uncomment this to turn on verbose mode. 
#export DH_VERBOSE=1

export DH_COMPAT=4
TAR_DIR = coreutils-4.5.3

# the dbs rules
include /usr/share/dbs/dbs-build.mk
include /usr/share/dbs/dpkg-arch.mk

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
CFLAGS = "-g -DSYSLOG_SUCCESS -DSYSLOG_FAILURE -DSYSLOG_NON_ROOT -O0"
else
CFLAGS = "-g -DSYSLOG_SUCCESS -DSYSLOG_FAILURE -DSYSLOG_NON_ROOT -O2"
endif
LDFLAGS = 

BIN_PROGS = cat chgrp chmod chown cp date dd df dir echo false ln ls mkdir \
	mknod mv pwd rm rmdir vdir sleep stty sync touch true uname
d=debian/coreutils

default: binary

configure: configure-stamp
configure-stamp: $(patched)
	dh_testdir

	cd $(BUILD_TREE) && CFLAGS=$(CFLAGS) LDFLAGS=$(LDFLAGS) ./configure \
		--build=$(DEB_BUILD_GNU_TYPE) --host=$(DEB_HOST_GNU_TYPE) \
		--prefix=/usr -v \
		--infodir=/usr/share/info --mandir=/usr/share/man

	touch configure-stamp

build: configure-stamp build-stamp
build-stamp: $(patched)
	dh_testdir

	cd $(BUILD_TREE) && $(MAKE)
#	cd $(BUILD_TREE) && $(MAKE) check

	touch build-stamp

clean:
	dh_testdir
	rm -f build-stamp configure-stamp

	rm -rf $(STAMP_DIR) $(SOURCE_DIR)

	dh_clean

install:
install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs

	cd $(BUILD_TREE) && $(MAKE) install DESTDIR=$(CURDIR)/$(d)

	# some things go in root rather than usr
	for f in $(BIN_PROGS); do \
		mv $(d)/usr/bin/$$f $(d)/bin/$$f; \
	done
	
	# dpkg contains its own md5sum (grrr)
	mv $(d)/usr/bin/md5sum $(d)/usr/bin/md5sum.textutils
	mv $(d)/usr/share/man/man1/md5sum.1 $(d)/usr/share/man/man1/md5sum.textutils.1

	# some things we don't do for hurd
ifneq ($(DEB_HOST_GNU_SYSTEM),gnu)
		# touch used to be in /usr/bin, don't break scripts
		ln -s /bin/touch $(d)/usr/bin/touch

		# remove stuff provided by other packages
		rm -f $(d)/usr/bin/kill $(d)/usr/share/man/man1/kill.1
		rm -f $(d)/usr/bin/su $(d)/usr/share/man/man1/su.1
endif

	# remove more stuff provided by other packages
	rm -f $(d)/usr/bin/hostname $(d)/usr/share/man/man1/hostname.1
	rm -f $(d)/usr/bin/uptime $(d)/usr/share/man/man1/uptime.1

	# link for archaic shells
	ln -s test $(d)/usr/bin/[
	ln -s test.1 $(d)/usr/share/man/man1/[.1

	# gnu thinks chroot is in bin, debian thinks it's in sbin
	install -d $(d)/usr/sbin $(d)/usr/share/man/man8
	mv $(d)/usr/bin/chroot $(d)/usr/sbin/chroot
	sed s/\"1\"/\"8\"/1 $(d)/usr/share/man/man1/chroot.1 > $(d)/usr/share/man/man8/chroot.8
	rm $(d)/usr/share/man/man1/chroot.1

	cp $(BUILD_TREE)/AUTHORS \
		$(BUILD_TREE)/NEWS $(BUILD_TREE)/README \
		$(BUILD_TREE)/THANKS \
		$(BUILD_TREE)/THANKS-to-translators $(BUILD_TREE)/TODO \
		$(d)/usr/share/doc/coreutils

	dh_install

# Build architecture-independent files here.
binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_installchangelogs -i
	dh_installdocs -i
	dh_installexamples -i
	dh_installinfo -i
	dh_installman -i
	dh_link -i
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

# Build architecture-dependent files here.
binary-arch: build install
	dh_testdir -a
	dh_testroot -a
	dh_installchangelogs -a $(BUILD_TREE)/ChangeLog 
	dh_installdocs -a
	dh_installexamples -a
	dh_installmenu -a
	dh_installinfo -a $(BUILD_TREE)/doc/coreutils.info
	dh_installman -a
ifeq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
	dh_strip -a
endif
	dh_link -a
	dh_compress -a
	dh_fixperms -a
ifeq ($(DEB_BUILD_GNU_SYSTEM),gnu)
	chmod u+s $(d)/usr/bin/su
endif
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install
